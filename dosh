#!/bin/bash
#
# Copyright (c) 2017-2019 GaÃ«l PORTAY
#
# SPDX-License-Identifier: MIT
#

# Called as program loader (shebang #!/usr/bin/dosh)
__="$_"
if [ "$__" != "/bin/bash" ] && [ "$__" = "$1" ]; then
	exec <"$1"
	shift
	set -- -s "$@"
	exec "$0" "$@"
elif [ "$__" != "/bin/bash" ] && [ "$__" = "$2" ]; then
	args="$1"
	shift
	exec <"$1"
	shift
	# shellcheck disable=SC2086
	set -- $args -s "$@"
	exec "$0" "$@"
fi

set -e
set -o pipefail

VERSION="1.7"

usage() {
	cat <<EOF
Usage: ${0##*/}    [(-|+)abefhmnuvxC] [(-|+)o shopt] [SCRIPT_FILE  [ARGS...]]
       ${0##*/} -c [(-|+)abefhmnuvxC] [(-|+)o shopt] COMMAND [NAME [ARGS...]]
       ${0##*/} -s [(-|+)abefhmnuvxC] [(-|+)o shopt]               [ARGS...]

Run a shell as user in a container and bind mount cwd.

POSIX Shell related options:
      -c                        Read commands from command-line.
      -i                        Set interactive.
      -s                        Read commands from standard-input.
      -abefhmnuvxC or -o shopt,
      +abefhmnuvxC or +o shopt  For a more thorough description of shopts,
                                please refers to sh help.

Bash specific options:
      -klprtBDEHIPT or -O shopt,
      +klprtBDEHIPT or +O shopt For a more thorough description of shopts,
                                please refers to bash help.

Dash specific options:
      -pEIV, +pEIV              For a more thorough description of shopts,
                                please refers to dash help.

Zsh specific options:
      -0123456789dgklprtxyBDEFGHIJKLMNOPQRSTUVWXYZ,
      +0123456789dgklprtxyBDEFGHIJKLMNOPQRSTUVWXYZ
                                For a more thorough description of shopts,
                                please refers to zsh help.

Docker related options:
      --dockerfile FILE         Path to the Dockerfile to use.
      --context TAR             Path to the context to send to docker daemon.
      --no-auto-context         Disable automatic context sent to docker daemon.
      --no-extra-options        Disable extra options given to docker commands.
      --directory DIR           Change to directory before doing anything else.
      --root                    Run as root.
      --dind                    Run dosh in dosh.
      --home                    Bind mount home directory.
      --shell SHELL             Set shell interpretor.
                                Equivalent to set DOSHELL=<SHELL>.
      --build                   Build image.
      --rebuild                 Build image again, verbosely.
                                Equivalent to --build --verbose.
      --rmi                     Remove image.
      --detach                  Detach container.
      --exec CONTAINER          Execute in container.
      --tag                     Print docker tag and exit.
      --no-do                   Do nothing; echo docker commands.
                                This option is deprecated; use --dry-run instead.
      --dry-run                 Do nothing; echo docker commands.

Miscellaneous options:
      --verbose                 Turn on verbose mode.
      --version                 Print version.
      --help                    Print usage.

Environment variables:
      DOCKER                    The docker executable.

      DOSHELL                   The full pathname to the shell to run in docker
                                image.
                                Equivalent to --shell <SHELL>.

      DOSHLVL                   Incremented by one each time an instance of dosh
                                is started.

      DOSH_DOCKERFILE           The filename of the Dockerfile to use.
                                Equivalent to --dockerfile <FILE>.

      DOSH_DOCKER_RUN_EXTRA_OPTS
                                Set additionnal parameters to docker run
                                command.

      DOSH_DOCKER_EXEC_EXTRA_OPTS
                                Set additionnal parameters to docker exec
                                command.

      DOSH_DOCKER_BUILD_EXTRA_OPTS
                                Set additionnal parameters to docker build
                                command.

      DOSH_DOCKER_RMI_EXTRA_OPTS
                                Set additionnal parameters to docker rmi
                                command.
EOF
}

run() {
	if [ -n "$dryrun" ]; then
		[ "$1" != "exec" ] || shift
		echo "${@// /\\ }" >&2
		return
	fi

	"$@"
}

get_tag() {
	echo "dosh-$(realpath "$1" | sha256sum - | cut -d' ' -f1)"
}

docker_build() {
	local iid
	local did
	local files
	local context_file

	if [ -n "$DOSH_NOBUILD" ]; then
		return
	fi

	# Inject both user and group id.
	iid="$(cat .iid 2>/dev/null || true; rm -f .iid)"
	IFS=":" read -r -a did <<< "$(grep '^docker' /etc/group)"
	cat "$1" - <<EOF >.iid

USER root
RUN grep -q "^$USER:" /etc/group \
 || groupadd --non-unique --gid ${GROUPS[0]} $USER \
 || addgroup -g ${GROUPS[0]} $USER
RUN grep -q "^$USER:" /etc/passwd \
 || useradd  --non-unique --gid ${GROUPS[0]} --uid $UID --create-home --home-dir $HOME --shell /bin/sh $USER \
 || adduser  -G $USER -u $UID -h $HOME -s /bin/sh -D $USER
RUN grep -q "^dind:" /etc/group \
 || groupadd --non-unique --gid ${did[2]} dind \
 || addgroup -g ${did[2]} dind
RUN grep -q "^dind:x:${did[2]}:.*$USER" /etc/group \
 || usermod  --append --group dind $USER \
 || addgroup $USER dind
RUN if test -d /etc/sudoers.d; then echo "%$USER ALL=(ALL) NOPASSWD: ALL" >"/etc/sudoers.d/$USER"; fi
EOF

	files=(.iid)
	context_file="$3"
	if ! [[ $context_file ]]; then
		while read -r -a words; do
			if [[ ${words[0]^^} =~ ^(ADD|COPY)$ ]]; then
				# Remove keyword and destination path
				unset 'words[0]'
				unset 'words[-1]'

				for word in "${words[@]}"; do
					# Skip long option and sources with schema://
					if [[ $word =~ ^-- ]] ||
					   [[ $word =~ ^.*\:// ]]; then
						continue
					fi

					# shellcheck disable=SC2206
					files+=($word)
				done
			elif [[ ${words[0]^^} =~ ^ENTRYPOINT$ ]]; then
				echo "Info: ENTRYPOINT is overridden by dosh"
			fi
		done <.iid >&2
	fi

	# Do not send build context to the daemon if neither ADD nor COPY instructions in Dockerfile.
	# shellcheck disable=SC2086 disable=SC2154
	if [[ ${#files[@]} -gt 1 ]] && [[ $no_auto_context ]]; then
		echo "Info: ADD or COPY sends build context to daemon" >&2
		echo "      Consider option --context <TAR> to speed up the build of image." >&2
		echo "      First, generate the context archive as suggested by the command below:" >&2
		echo "          tar cf context.tar ${files[*]}" >&2
		echo "      Then, run dosh again and tell it to use the context archive:" >&2
		echo "          $0 --context context.tar ${BASH_ARGV[*]}" >&2
		run $DOCKER build "${buildopts[@]}" $DOSH_DOCKER_BUILD_EXTRA_OPTS --tag "$2" --file .iid .
	else
		if ! [[ $context_file ]]; then
			run tar c "${files[@]}"
		else
			run tar rf "$context_file" ".iid"
			run cat "$context_file"
		fi | \
		run $DOCKER build "${buildopts[@]}" $DOSH_DOCKER_BUILD_EXTRA_OPTS --tag "$2" --file .iid -
	fi

	rm -f .iid
}

docker_rmi() {
	# shellcheck disable=SC2086
	run $DOCKER rmi $DOSH_DOCKER_RMI_EXTRA_OPTS "$@"
}

is_doshopt() {
	if [[ "$1" =~ ^--(no-auto-context|no-extra-options|root|dind|home|build|rebuild|rmi|detach)$ ]]; then
		return 0
	fi

	return 1
}

is_doshopt_argument() {
	if [[ "$1" =~ ^--(dockerfile|context|directory|shell|detach|exec)$ ]]; then
		return 0
	fi

	return 1
}

is_shopt() {
	# Do not handle -o shoptname here
	# sh (only)
	if [[ "$1" =~ ^[-+][abcefhimnsuvxC]$ ]]; then
		return 0
	fi

	# bash (specific)
	if [ "${DOSHELL##*/}" == "bash" ] &&
	   [[ "$1" =~ ^[-+][klprtBDEHIPT]$ ]]; then
		return 0
	fi

	# dash (specific)
	if [ "${DOSHELL##*/}" == "dash" ] &&
	   [[ "$1" =~ ^[-+][pEIV]$ ]]; then
		return 0
	fi

	# zsh (specific)
	if [ "${DOSHELL##*/}" == "zsh" ] &&
	   [[ "$1" =~ ^[-+][0123456789dgklprtxyBDEFGHIJKLMNOPQRSTUVWXYZ]$ ]]; then
		return 0
	fi

	return 1
}

is_shopt_argument() {
	# sh (only)
	if [[ "$1" =~ ^[-+][o]$ ]]; then
		return 0
	fi

	# bash (specific)
	if [ "${DOSHELL##*/}" == "bash" ] &&
	   [[ "$1" =~ ^[-+]O$ ]]; then
		return 0
	fi

	return 1
}

shopts=()
dockerfile="${DOSH_DOCKERFILE:-Dockerfile}"
directory="."
opts=()
buildopts=("--quiet")
DOSHELL="${DOSHELL:-/bin/sh}"
DOCKER="${DOCKER:-docker}"
while [ "$#" -ne 0 ]; do
	if [ "$1" = "--help" ]; then
		usage
		exit 0
	elif [ "$1" = "--version" ]; then
		echo "$VERSION"
		exit
	elif is_doshopt "$1"; then
		optname="${1//-/_}"
		optname="${optname:2}"
		eval "$optname=1"
	elif is_doshopt_argument "$1"; then
		optname="${1//-/_}"
		optname="${optname:2}"
		eval "$optname=\"$2\""
		shift
	elif [ "$1" = "--tag" ]; then
		get_tag "$directory/$dockerfile"
		exit
	elif [ "$1" = "--dry-run" ] || [ "$1" = "--no-do" ]; then
		# shellcheck disable=SC2209
		dryrun=true
	elif [ "$1" = "--verbose" ]; then
		verbose=true
		buildopts=()
	elif is_shopt "$1"; then
		shopts+=("$1")
		eval "opt_${1:1:1}=1"
	elif is_shopt_argument "$1"; then
		shopts+=("$1" "$2")
		eval "opt_${1:1:1}=\"$2\""
		shift
	elif [ "$1" = "--" ]; then
		shift
		break
	else
		break
	fi
	shift
done

# Apply dosh options to dosh environment variables
# --shell SHELL to DOSHELL
# shellcheck disable=SC2154
if [[ $shell ]]; then
	DOSHELL="$shell"
fi
# --dockerfile FILE to DOSH_DOCKERFILE
if [[ $dockerfile ]]; then
	DOSH_DOCKERFILE="$dockerfile"
fi
# --no-extra-options resets DOSH_DOCKER_*_EXTRA_OPTS
# shellcheck disable=SC2154
if [[ $no_extra_options ]]; then
	DOSH_DOCKER_RUN_EXTRA_OPTS=
	DOSH_DOCKER_EXEC_EXTRA_OPTS=
	DOSH_DOCKER_BUILD_EXTRA_OPTS=
	DOSH_DOCKER_RMI_EXTRA_OPTS=
fi

# Change directory
cd "$directory"

# Source local profile
if [ -e ".doshrc" ]; then
	. .doshrc
fi

# Remove image and exit
# shellcheck disable=SC2154
if [[ $rmi ]]; then
	# Remove image if exist
	tag="$(get_tag "$DOSH_DOCKERFILE")"
	docker_rmi "$tag" "$@" >&2
	exit
fi

# Run in a new container
# shellcheck disable=SC2154
if ! [[ $exec ]]; then
	# Rebuild or automatically build image if it does not exist
	tag="$(get_tag "$DOSH_DOCKERFILE")"
	imageid="$($DOCKER images -q "$tag")"
	if [[ $build ]] || [[ $rebuild ]] || ! [[ $imageid ]]; then
		# Reset quiet option when image does not exist or rebuild or if verbose option is set
		if ! [[ $imageid ]] || [[ $rebuild ]] || [[ $verbose ]]; then
			buildopts=()
		fi
		# Remove previous image
		if [[ $imageid ]]; then
			docker_rmi "$tag" >&2
		fi
		docker_build "$DOSH_DOCKERFILE" "$tag" "$context" >&2
	fi

	# Detach container
	if [[ $detach ]]; then
		opts+=("--detach")
	# Remove the container at exit
	else
		opts+=("--rm")
	fi

	# Bind mount home
	if [[ $home ]]; then
		opts+=("--volume" "$HOME:/home/$USER")
	# Bind mount current working directory
	else
		opts+=("--volume" "$PWD:$PWD")
	fi
fi

# shellcheck disable=SC2154
# Set current user privileges for dosh-in-dosh
if [[ $dind ]]; then
	opts+=("--user" "$UID:dind")
	opts+=("--volume" "/var/run/docker.sock:/var/run/docker.sock")
	opts+=("--volume" "$0:/bin/dosh:ro")
# Set current user privileges
elif ! [[ $root ]]; then
	opts+=("--user" "$UID:${GROUPS[0]}")
fi

# Set interactive
# shellcheck disable=SC2154
if [[ $opt_i ]] || [[ $opt_s ]] || [ "$#" -eq 0 ]; then
	opts+=("--interactive")

	# Allocate a pseudo-TTY if stdin/stderr are TTY
	if [ -t 0 ] && [ -t 2 ]; then
		opts+=("--tty")
	fi
fi

# Change to present working directory
opts+=("--workdir" "$PWD")

# Run command from arguments
# shellcheck disable=SC2154
if [[ $opt_c ]]; then
	command="$1"
	shift
	set -- "${shopts[@]}" "$command" "$@"
# Read command from stdin or no command or invalid
else
	set -- "${shopts[@]}" "$@"
fi

# Execute in existing container
# shellcheck disable=SC2086
if [[ $exec ]]; then
	run exec $DOCKER exec "${opts[@]}" $DOSH_DOCKER_EXEC_EXTRA_OPTS "$exec" "$DOSHELL" "$@"
# Run in a new container
else
	opts+=("--env" "DOSHLVL=$((DOSHLVL+1))")
	opts+=("--entrypoint" "$DOSHELL")
	if [[ $verbose ]]; then
		echo "$tag"
	fi >&2
	run exec $DOCKER run "${opts[@]}" $DOSH_DOCKER_RUN_EXTRA_OPTS "$tag" "$@"
fi
